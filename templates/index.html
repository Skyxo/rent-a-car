<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Application de génération de Procès-Verbaux de Matériel Loué - France Montage Briand">
    <meta name="theme-color" content="#003d7a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PV Matériel Loué - France Montage Briand</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icone.png') }}">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- CSS personnalisé -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Header avec logo -->
    <header class="clc-header">
        <div class="container">
            <div class="fmb-logo-text">
                <img src="{{ url_for('static', filename='logo_inverse.png') }}" alt="France Montage - Groupe Briand" style="max-width: 100%; width: 800px; height: auto; display: block; margin: 0 auto;">
            </div>
            <h2 class="text-center mt-1 mb-0">Procès-Verbal de Matériel Loué</h2>
        </div>
    </header>

    <!-- Indicateur PV Actuel (Fixe en haut) -->
    <div id="currentPVIndicator" class="current-pv-indicator alert alert-info d-flex align-items-start" role="alert">
        <div class="container" style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 1rem;">
            <div class="pv-indicator-icon me-2">
                <i class="fas fa-file-alt fs-3"></i>
            </div>
            <div class="flex-grow-1">
                <div class="pv-indicator-status">
                    <strong>Nouveau PV en cours</strong>
                </div>
                <div class="pv-indicator-details small mt-1">
                    Le formulaire est vide et prêt à être rempli
                </div>
            </div>
            <!-- Sélecteur de type PV compact (visible au scroll) -->
            <div id="pvTypeCompact" class="pv-type-compact" style="display: none;">
                <div class="btn-group btn-group-sm" role="group" aria-label="Type de PV">
                    <input type="radio" class="btn-check" name="pv_type_compact" id="pv_type_compact_reception" value="reception" checked>
                    <label class="btn btn-outline-primary btn-sm" for="pv_type_compact_reception">
                        <i class="fas fa-arrow-down"></i> Réception
                    </label>
                    
                    <input type="radio" class="btn-check" name="pv_type_compact" id="pv_type_compact_retour" value="retour">
                    <label class="btn btn-outline-primary btn-sm" for="pv_type_compact_retour">
                        <i class="fas fa-arrow-up"></i> Retour
                    </label>
                </div>
            </div>
        </div>
    </div>

    <main class="container" style="max-width: 1400px; margin-left: auto; margin-right: auto; margin-top: 0; padding-top: 1rem;">
        <!-- Messages Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Bouton Configuration SMTP -->
        <div class="mb-3 text-end">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#smtpConfigModal">
                <i class="fas fa-cog"></i> Configuration Email
            </button>
        </div>

        <!-- Section de gestion des PV sauvegardés - Interface améliorée -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-gradient-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Mes Procès-Verbaux</h5>
                    <button type="button" class="btn btn-light btn-sm" id="newPVBtn">
                        <i class="fas fa-plus-circle me-1"></i> Nouveau PV
                    </button>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Section PV sauvegardés -->
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <h6 class="text-muted mb-0">
                        <i class="fas fa-history me-2"></i>PV Sauvegardés
                        <span class="badge bg-secondary" id="pvCountBadge">0</span>
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="togglePVListBtn" title="Afficher/Masquer la liste">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>

                <!-- Barre de recherche et filtre -->
                <div id="pvSearchSection" class="mb-3">
                    <div class="card shadow-sm" style="background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%); border-left: 4px solid #0d6efd;">
                        <div class="card-body">
                            <h6 class="card-title mb-3 fw-bold text-primary">
                                <i class="fas fa-filter me-2"></i>Rechercher et filtrer les PV
                            </h6>
                            
                        <!-- Barre de recherche principale -->
                        <div class="d-flex gap-2 mb-3">
                            <div class="input-group flex-grow-1">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control form-control-lg" id="pvSearchInput" 
                                       placeholder="Rechercher... (Appuyez sur Entrée pour cumuler les filtres)"
                                       style="border-left: none;">
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-lg" id="toggleFiltersBtn">
                                <i class="fas fa-filter me-2"></i>Filtrer
                            </button>
                        </div>
                        
                        <!-- Puces de filtres actifs -->
                        <div id="activeFiltersContainer" class="mb-3" style="display: none;">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <small class="text-muted me-2">
                                    <i class="fas fa-filter me-1"></i>Filtres actifs:
                                </small>
                                <div id="activeFiltersBadges" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                        
                        <!-- Filtres -->
                        <div id="pvFiltersSection" style="display: none;">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-paper-plane me-1"></i>Dernier envoi
                                </label>
                                <select class="form-select select2-filter" id="pvFilterLastSent" style="width: 100%;">
                                    <option value="">Toutes dates</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-tasks me-1"></i>Complétion
                                </label>
                                <select class="form-select select2-filter" id="pvFilterCompletion" style="width: 100%;">
                                    <option value="">Tous états</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-hard-hat me-1"></i>Chantier
                                </label>
                                <select class="form-select select2-filter" id="pvFilterChantier" style="width: 100%;">
                                    <option value="">Tous chantiers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-tools me-1"></i>Type matériel
                                </label>
                                <select class="form-select select2-filter" id="pvFilterMaterielType" style="width: 100%;">
                                    <option value="">Tous types</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-2 mt-1">
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-user-tie me-1"></i>Responsable
                                </label>
                                <select class="form-select select2-filter" id="pvFilterResponsable" style="width: 100%;">
                                    <option value="">Tous responsables</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-building me-1"></i>Fournisseur
                                </label>
                                <select class="form-select select2-filter" id="pvFilterFournisseur" style="width: 100%;">
                                    <option value="">Tous fournisseurs</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-envelope me-1"></i>Email conducteur
                                </label>
                                <select class="form-select select2-filter" id="pvFilterEmailConducteur" style="width: 100%;">
                                    <option value="">Tous emails conducteur</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-calendar-check me-1"></i>Date réception
                                </label>
                                <select class="form-select select2-filter" id="pvFilterDateReception" style="width: 100%;">
                                    <option value="">Toutes dates</option>
                                </select>
                                <input type="date" class="form-control mt-1 d-none" id="pvFilterDateReceptionCustom">
                            </div>
                        </div>
                        
                        <div class="row g-2 mt-1">
                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">
                                    <i class="fas fa-calendar-minus me-1"></i>Date retour
                                </label>
                                <select class="form-select select2-filter" id="pvFilterDateRetour" style="width: 100%;">
                                    <option value="">Toutes dates</option>
                                </select>
                                <input type="date" class="form-control mt-1 d-none" id="pvFilterDateRetourCustom">
                            </div>
                            <div class="col-md-9 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">
                                    <i class="fas fa-eraser me-1"></i>Réinitialiser les filtres
                                </button>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Compteur de résultats -->
                            <div class="mt-3 text-center">
                                <span class="badge bg-primary fs-6 px-3 py-2">
                                    <i class="fas fa-file-alt me-2"></i>
                                    <span id="pvFilterCount">0</span> PV trouvé(s)
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des PV sous forme de cartes avec scroll -->
                <div id="pvListContainer" class="pv-list-scrollable mb-3">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i>
                        <p>Aucun PV sauvegardé</p>
                        <small>Créez votre premier PV en remplissant le formulaire ci-dessous</small>
                    </div>
                </div>

                <!-- Select caché pour compatibilité avec le code existant -->
                <select class="form-select d-none" id="savedPVSelect">
                    <option value="">-- Sélectionnez un PV --</option>
                </select>
                
                <div class="d-none" id="pvStatusBadge"></div>
            </div>
        </div>

        <!-- Section: Email Entreprise Global -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <i class="fas fa-building"></i> Email Entreprise (global)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <label for="global_email_entreprise" class="form-label">Email entreprise <span class="text-danger">*</span></label>
                        <select class="form-select select2-field" id="global_email_entreprise" name="global_email_entreprise" required style="width: 100%;">
                            <option value=""></option>
                        </select>
                        <small class="text-muted">Tous les PV seront automatiquement envoyés en copie à cette adresse. Cette valeur sera pré-remplie pour chaque nouveau PV.</small>
                    </div>
                </div>
            </div>
        </div>

        <form id="pvForm" method="POST" action="/submit">
            <input type="hidden" id="pvId" name="pv_id" value="">
            
            <!-- Section 1: Informations Générales -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-info-circle"></i> Informations Générales
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="chantier" class="form-label">Chantier <span class="text-danger">*</span></label>
                            <select class="form-select select2-field" id="chantier" name="chantier" required style="width: 100%;">
                                <option value=""></option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email_conducteur" class="form-label">Email(s) destinataire(s) <span class="text-danger">*</span></label>
                            <select class="form-select select2-field" id="email_conducteur" name="email_conducteur" multiple required style="width: 100%;">
                            </select>
                            <small class="text-muted">Le PV sera envoyé à ces adresses (plusieurs emails possibles)</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email_entreprise" class="form-label">Email entreprise <span class="text-danger">*</span></label>
                            <select class="form-select select2-field" id="email_entreprise" name="email_entreprise" required style="width: 100%;">
                                <option value=""></option>
                            </select>
                            <small class="text-muted">Tous les PV seront également envoyés à cette adresse</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="responsable" class="form-label">Responsable Chantier</label>
                            <select class="form-select select2-field" id="responsable" name="responsable" style="width: 100%;">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="materiel_numero" class="form-label">Matériel / N°</label>
                            <select class="form-select select2-field" id="materiel_numero" name="materiel_numero" style="width: 100%;">
                                <option value=""></option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="materiel_type" class="form-label">Type</label>
                            <select class="form-select select2-field" id="materiel_type" name="materiel_type" style="width: 100%;">
                                <option value=""></option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fournisseur" class="form-label">Fournisseur</label>
                            <select class="form-select select2-field" id="fournisseur" name="fournisseur" style="width: 100%;">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Type de PV avec barre sticky -->
            <div class="card mb-4 border-primary" id="pvTypeSection">
                <div class="card-body text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Choisissez "Réception" pour l'arrivée du matériel sur chantier, ou "Retour" pour son départ du chantier.
                    </small>
                </div>
                <!-- Placeholder pour éviter le saut quand la barre devient sticky -->
                <div id="stickyPlaceholder" style="display: none;"></div>
                <div class="card-header bg-primary text-white sticky-pv-type-header" id="stickyPVTypeHeader">
                    <div class="container" style="max-width: 1400px; margin: 0 auto;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clipboard-list"></i> Type de Procès-Verbal</span>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Type de PV">
                                <input type="radio" class="btn-check" name="pv_type_sticky" id="pv_type_sticky_reception" value="reception" checked>
                                <label class="btn btn-outline-light btn-sm" for="pv_type_sticky_reception">
                                    <i class="fas fa-arrow-down"></i> Réception
                                </label>
                                
                                <input type="radio" class="btn-check" name="pv_type_sticky" id="pv_type_sticky_retour" value="retour">
                                <label class="btn btn-outline-light btn-sm" for="pv_type_sticky_retour">
                                    <i class="fas fa-arrow-up"></i> Retour
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Dates et Compteurs -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-calendar-alt"></i> Dates et Compteurs
                    <span class="badge bg-primary ms-2" id="pv_type_badge_dates" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <h5 class="text-clc-navy mb-3"><i class="fas fa-arrow-down"></i> Réception</h5>
                            <div class="mb-3">
                                <label for="date_reception" class="form-label">Date de réception</label>
                                <input type="date" class="form-control" id="date_reception" name="date_reception">
                            </div>
                            <div class="mb-3">
                                <label for="compteur_reception" class="form-label">Compteur d'heure</label>
                                <input type="number" class="form-control" id="compteur_reception" name="compteur_reception" min="0" step="0.1">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="text-clc-navy mb-3"><i class="fas fa-arrow-up"></i> Retour</h5>
                            <div class="mb-3">
                                <label for="date_retour" class="form-label">Date de retour</label>
                                <input type="date" class="form-control" id="date_retour" name="date_retour">
                            </div>
                            <div class="mb-3">
                                <label for="compteur_retour" class="form-label">Compteur d'heure</label>
                                <input type="number" class="form-control" id="compteur_retour" name="compteur_retour" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Inspection - Aspect Extérieur -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-search"></i> Inspection - Aspect Extérieur
                    <span class="badge bg-primary ms-2" id="pv_type_badge_exterieur" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered inspection-table">
                            <thead>
                                <tr>
                                    <th>Élément</th>
                                    <th class="text-center reception-column">Réception</th>
                                    <th class="text-center retour-column">Retour</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="element-cell">
                                            <div class="element-title">Carrosserie / Rétroviseurs</div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                    data-field="carrosserie" 
                                                    onclick="openPhotoModal('carrosserie')">
                                                <i class="fas fa-plus"></i> Photo <i class="fas fa-camera"></i>
                                            </button>
                                            <div class="photo-preview-container mt-2" id="photos_preview_carrosserie"></div>
                                            <div style="display: none;">
                                                <div class="multi-photo-container" id="photos_carrosserie_reception">
                                                    <input type="file" class="form-control form-control-sm photo-upload" name="photo_carrosserie_reception" accept="image/*" data-container="photos_carrosserie_reception" data-field="carrosserie_reception" multiple>
                                                </div>
                                                <div class="multi-photo-container" id="photos_carrosserie_retour">
                                                    <input type="file" class="form-control form-control-sm photo-upload" name="photo_carrosserie_retour" accept="image/*" data-container="photos_carrosserie_retour" data-field="carrosserie_retour" multiple>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="carrosserie_reception" id="carrosserie_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="carrosserie_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="carrosserie_reception" id="carrosserie_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="carrosserie_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="carrosserie_retour" id="carrosserie_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="carrosserie_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="carrosserie_retour" id="carrosserie_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="carrosserie_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td>
                                        <div class="element-cell">
                                            <div class="element-title">Éclairage / Gyrophare</div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                    data-field="eclairage" 
                                                    onclick="openPhotoModal('eclairage')">
                                                <i class="fas fa-plus"></i> Photo <i class="fas fa-camera"></i>
                                            </button>
                                            <div class="photo-preview-container mt-2" id="photos_preview_eclairage"></div>
                                            <div style="display: none;">
                                                <div class="multi-photo-container" id="photos_eclairage_reception">
                                                    <input type="file" class="form-control form-control-sm photo-upload" name="photo_eclairage_reception" accept="image/*" data-container="photos_eclairage_reception" data-field="eclairage_reception" multiple>
                                                </div>
                                                <div class="multi-photo-container" id="photos_eclairage_retour">
                                                    <input type="file" class="form-control form-control-sm photo-upload" name="photo_eclairage_retour" accept="image/*" data-container="photos_eclairage_retour" data-field="eclairage_retour" multiple>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="eclairage_reception" id="eclairage_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="eclairage_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="eclairage_reception" id="eclairage_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="eclairage_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="eclairage_retour" id="eclairage_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="eclairage_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="eclairage_retour" id="eclairage_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="eclairage_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Pneumatiques</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('pneumatiques')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_pneumatiques"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_pneumatiques_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_pneumatiques_reception" accept="image/*" 
                                                   data-container="photos_pneumatiques_reception" data-field="pneumatiques_reception" multiple>
                                            <div class="multi-photo-container" id="photos_pneumatiques_reception"></div>
                                            <input type="file" id="photo_pneumatiques_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_pneumatiques_retour" accept="image/*" 
                                                   data-container="photos_pneumatiques_retour" data-field="pneumatiques_retour" multiple>
                                            <div class="multi-photo-container" id="photos_pneumatiques_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="pneumatiques_reception" id="pneumatiques_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="pneumatiques_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="pneumatiques_reception" id="pneumatiques_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="pneumatiques_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="pneumatiques_retour" id="pneumatiques_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="pneumatiques_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="pneumatiques_retour" id="pneumatiques_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="pneumatiques_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Panier (si applicable)</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('panier')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_panier"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_panier_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_panier_reception" accept="image/*" 
                                                   data-container="photos_panier_reception" data-field="panier_reception" multiple>
                                            <div class="multi-photo-container" id="photos_panier_reception"></div>
                                            <input type="file" id="photo_panier_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_panier_retour" accept="image/*" 
                                                   data-container="photos_panier_retour" data-field="panier_retour" multiple>
                                            <div class="multi-photo-container" id="photos_panier_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="panier_reception" id="panier_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="panier_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="panier_reception" id="panier_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="panier_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="panier_retour" id="panier_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="panier_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="panier_retour" id="panier_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="panier_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Flexibles, faisceaux électrique</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('flexibles')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_flexibles"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_flexibles_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_flexibles_reception" accept="image/*" 
                                                   data-container="photos_flexibles_reception" data-field="flexibles_reception" multiple>
                                            <div class="multi-photo-container" id="photos_flexibles_reception"></div>
                                            <input type="file" id="photo_flexibles_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_flexibles_retour" accept="image/*" 
                                                   data-container="photos_flexibles_retour" data-field="flexibles_retour" multiple>
                                            <div class="multi-photo-container" id="photos_flexibles_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="flexibles_reception" id="flexibles_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="flexibles_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="flexibles_reception" id="flexibles_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="flexibles_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="flexibles_retour" id="flexibles_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="flexibles_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="flexibles_retour" id="flexibles_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="flexibles_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Commandes</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('commandes')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_commandes"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_commandes_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_commandes_reception" accept="image/*" 
                                                   data-container="photos_commandes_reception" data-field="commandes_reception" multiple>
                                            <div class="multi-photo-container" id="photos_commandes_reception"></div>
                                            <input type="file" id="photo_commandes_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_commandes_retour" accept="image/*" 
                                                   data-container="photos_commandes_retour" data-field="commandes_retour" multiple>
                                            <div class="multi-photo-container" id="photos_commandes_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="commandes_reception" id="commandes_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="commandes_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="commandes_reception" id="commandes_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="commandes_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="commandes_retour" id="commandes_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="commandes_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="commandes_retour" id="commandes_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="commandes_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 4: Inspection - Fonctionnement -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-cogs"></i> Inspection - Fonctionnement
                    <span class="badge bg-primary ms-2" id="pv_type_badge_fonctionnement" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered inspection-table">
                            <thead>
                                <tr>
                                    <th>Élément</th>
                                    <th class="text-center reception-column">Réception</th>
                                    <th class="text-center retour-column">Retour</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Conformité réglementaire</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('conformite')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_conformite"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_conformite_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_conformite_reception" accept="image/*" 
                                                   data-container="photos_conformite_reception" data-field="conformite_reception" multiple>
                                            <div class="multi-photo-container" id="photos_conformite_reception"></div>
                                            <input type="file" id="photo_conformite_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_conformite_retour" accept="image/*" 
                                                   data-container="photos_conformite_retour" data-field="conformite_retour" multiple>
                                            <div class="multi-photo-container" id="photos_conformite_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="conformite_reception" id="conformite_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="conformite_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="conformite_reception" id="conformite_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="conformite_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="conformite_retour" id="conformite_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="conformite_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="conformite_retour" id="conformite_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="conformite_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Essais de mobilités</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('mobilites')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_mobilites"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_mobilites_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_mobilites_reception" accept="image/*" 
                                                   data-container="photos_mobilites_reception" data-field="mobilites_reception" multiple>
                                            <div class="multi-photo-container" id="photos_mobilites_reception"></div>
                                            <input type="file" id="photo_mobilites_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_mobilites_retour" accept="image/*" 
                                                   data-container="photos_mobilites_retour" data-field="mobilites_retour" multiple>
                                            <div class="multi-photo-container" id="photos_mobilites_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="mobilites_reception" id="mobilites_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="mobilites_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="mobilites_reception" id="mobilites_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="mobilites_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="mobilites_retour" id="mobilites_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="mobilites_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="mobilites_retour" id="mobilites_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="mobilites_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Essais de nacelles</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('nacelles')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_nacelles"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_nacelles_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_nacelles_reception" accept="image/*" 
                                                   data-container="photos_nacelles_reception" data-field="nacelles_reception" multiple>
                                            <div class="multi-photo-container" id="photos_nacelles_reception"></div>
                                            <input type="file" id="photo_nacelles_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_nacelles_retour" accept="image/*" 
                                                   data-container="photos_nacelles_retour" data-field="nacelles_retour" multiple>
                                            <div class="multi-photo-container" id="photos_nacelles_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="nacelles_reception" id="nacelles_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="nacelles_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="nacelles_reception" id="nacelles_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="nacelles_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="nacelles_retour" id="nacelles_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="nacelles_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="nacelles_retour" id="nacelles_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="nacelles_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="element-cell">
                                        <div class="element-title">Dispositifs de sécurité</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-photo-btn mt-2" 
                                                onclick="openPhotoModal('securite')">
                                            <i class="fas fa-camera"></i> + Photo
                                        </button>
                                        <div class="photo-preview-container" id="preview_securite"></div>
                                        <div style="display: none;">
                                            <input type="file" id="photo_securite_reception" class="form-control form-control-sm photo-upload" 
                                                   name="photo_securite_reception" accept="image/*" 
                                                   data-container="photos_securite_reception" data-field="securite_reception" multiple>
                                            <div class="multi-photo-container" id="photos_securite_reception"></div>
                                            <input type="file" id="photo_securite_retour" class="form-control form-control-sm photo-upload" 
                                                   name="photo_securite_retour" accept="image/*" 
                                                   data-container="photos_securite_retour" data-field="securite_retour" multiple>
                                            <div class="multi-photo-container" id="photos_securite_retour"></div>
                                        </div>
                                    </td>
                                    <td class="reception-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="securite_reception" id="securite_reception_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="securite_reception_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="securite_reception" id="securite_reception_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="securite_reception_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                    <td class="retour-column">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="securite_retour" id="securite_retour_bon" value="bon">
                                            <label class="btn btn-outline-success btn-sm" for="securite_retour_bon">Bon</label>
                                            
                                            <input type="radio" class="btn-check" name="securite_retour" id="securite_retour_defectueux" value="defectueux">
                                            <label class="btn btn-outline-danger btn-sm" for="securite_retour_defectueux">Défectueux</label>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 5: Fluides -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-tint"></i> Fluides
                    <span class="badge bg-primary ms-2" id="pv_type_badge_fluides" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-6 pv-reception-col">
                            <h5 class="text-clc-navy mb-3">Réception</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Niveau Carburant: <span id="carburant_reception_value">0</span></label>
                                <input type="range" class="form-range" name="carburant_reception" id="carburant_reception" min="0" max="100" step="5" value="0" oninput="document.getElementById('carburant_reception_value').textContent = this.value + '%'">
                                <div class="d-flex justify-content-between text-muted" style="font-size: 0.85rem;">
                                    <span>Vide</span>
                                    <span>1/4</span>
                                    <span>1/2</span>
                                    <span>3/4</span>
                                    <span>Plein</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_carburant_reception input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_carburant_reception">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_carburant_reception" accept="image/*" data-container="photos_carburant_reception" data-field="carburant_reception" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Photo de la jauge de carburant</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Fuites</label>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Moteur</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_moteur_reception" id="fuite_moteur_reception_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_moteur_reception_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_moteur_reception" id="fuite_moteur_reception_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_moteur_reception_oui">Oui</label>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Hydraulique</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_hydraulique_reception" id="fuite_hydraulique_reception_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_hydraulique_reception_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_hydraulique_reception" id="fuite_hydraulique_reception_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_hydraulique_reception_oui">Oui</label>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Gasoil</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_gasoil_reception" id="fuite_gasoil_reception_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_gasoil_reception_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_gasoil_reception" id="fuite_gasoil_reception_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_gasoil_reception_oui">Oui</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_fuite_reception input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_fuite_reception">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_fuite_reception" accept="image/*" data-container="photos_fuite_reception" data-field="fuite_reception" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Ajoutez une photo si vous constatez des fuites</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 pv-retour-col">
                            <h5 class="text-clc-navy mb-3">Retour</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Niveau Carburant: <span id="carburant_retour_value">0</span></label>
                                <input type="range" class="form-range" name="carburant_retour" id="carburant_retour" min="0" max="100" step="5" value="0" oninput="document.getElementById('carburant_retour_value').textContent = this.value + '%'">
                                <div class="d-flex justify-content-between text-muted" style="font-size: 0.85rem;">
                                    <span>Vide</span>
                                    <span>1/4</span>
                                    <span>1/2</span>
                                    <span>3/4</span>
                                    <span>Plein</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_carburant_retour input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_carburant_retour">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_carburant_retour" accept="image/*" data-container="photos_carburant_retour" data-field="carburant_retour" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Photo de la jauge de carburant</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Fuites</label>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Moteur</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_moteur_retour" id="fuite_moteur_retour_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_moteur_retour_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_moteur_retour" id="fuite_moteur_retour_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_moteur_retour_oui">Oui</label>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Hydraulique</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_hydraulique_retour" id="fuite_hydraulique_retour_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_hydraulique_retour_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_hydraulique_retour" id="fuite_hydraulique_retour_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_hydraulique_retour_oui">Oui</label>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label" style="font-weight: normal; font-size: 0.9rem;">Gasoil</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="fuite_gasoil_retour" id="fuite_gasoil_retour_non" value="non">
                                        <label class="btn btn-outline-success btn-sm" for="fuite_gasoil_retour_non">Non</label>
                                        
                                        <input type="radio" class="btn-check" name="fuite_gasoil_retour" id="fuite_gasoil_retour_oui" value="oui">
                                        <label class="btn btn-outline-danger btn-sm" for="fuite_gasoil_retour_oui">Oui</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_fuite_retour input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_fuite_retour">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_fuite_retour" accept="image/*" data-container="photos_fuite_retour" data-field="fuite_retour" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Ajoutez une photo si vous constatez des fuites</small>
                            </div>
                                <small class="text-muted">Ajoutez une photo si vous constatez des fuites</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Observations -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-comment"></i> Observations
                    <span class="badge bg-primary ms-2" id="pv_type_badge_observations" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-6 mb-3 pv-reception-col">
                            <label for="observations_reception" class="form-label">Observations Réception</label>
                            <textarea class="form-control" id="observations_reception" name="observations_reception" rows="4"></textarea>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_observation_reception input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_observation_reception">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_observation_reception" accept="image/*" data-container="photos_observation_reception" data-field="observation_reception" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Ajoutez des photos pour illustrer vos observations</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3 pv-retour-col">
                            <label for="observations_retour" class="form-label">Observations Retour</label>
                            <textarea class="form-control" id="observations_retour" name="observations_retour" rows="4"></textarea>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelector('#photos_observation_retour input').click()">
                                    <i class="fas fa-camera"></i> + Photo
                                </button>
                                <div class="photo-cell-wrapper" style="margin-top: 0.5rem;">
                                    <div class="multi-photo-container" id="photos_observation_retour">
                                        <input type="file" class="form-control form-control-sm photo-upload" name="photo_observation_retour" accept="image/*" data-container="photos_observation_retour" data-field="observation_retour" multiple style="display: none;">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">Ajoutez des photos pour illustrer vos observations</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 7: Signatures -->
            <div class="card mb-4">
                <div class="card-header clc-card-header">
                    <i class="fas fa-signature"></i> Signatures
                    <span class="badge bg-primary ms-2" id="pv_type_badge_signatures" style="display: none;"></span>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-6 mb-4">
                            <h5 class="text-clc-navy mb-3">VISA Réception</h5>
                            <div class="signature-container">
                                <canvas id="signatureReception" class="signature-canvas"></canvas>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="clearSignature('Reception')">
                                    <i class="fas fa-eraser"></i> Effacer
                                </button>
                            </div>
                            <input type="hidden" name="signature_reception" id="signature_reception_data">
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <h5 class="text-clc-navy mb-3">VISA Retour</h5>
                            <div class="signature-container">
                                <canvas id="signatureRetour" class="signature-canvas"></canvas>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="clearSignature('Retour')">
                                    <i class="fas fa-eraser"></i> Effacer
                                </button>
                            </div>
                            <input type="hidden" name="signature_retour" id="signature_retour_data">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-info btn-lg w-100" id="downloadPVBtn">
                                <i class="fas fa-download"></i> Télécharger le PDF
                                <br><small class="d-block mt-1">Générer et télécharger le PDF</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-clc-red btn-lg w-100" id="sendEmailBtn">
                                <i class="fas fa-paper-plane"></i> Envoyer par Email
                                <br><small class="d-block mt-1">Créer le PDF et l'envoyer</small>
                            </button>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Le PV est sauvegardé automatiquement à chaque modification
                        </small>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Bouton de navigation scroll -->
        <button id="scrollNavBtn" class="btn btn-primary shadow-lg" style="display: none;">
            <i class="fas fa-chevron-down" id="scrollNavIcon"></i>
        </button>
    </main>

    <!-- Modal Configuration SMTP -->
    <div class="modal fade" id="smtpConfigModal" tabindex="-1" aria-labelledby="smtpConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="smtpConfigModalLabel">
                        <i class="fas fa-cog"></i> Configuration Email (SMTP)
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle"></i>
                                <strong>Configuration de l'envoi automatique des emails</strong>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#helpInstructions" aria-expanded="false" aria-controls="helpInstructions">
                                <i class="fas fa-question-circle"></i> Aide
                            </button>
                        </div>
                        <p class="mt-2 mb-0">Pour que l'application puisse envoyer les PV par email automatiquement, vous devez configurer une adresse email.</p>
                        
                        <div class="collapse mt-3" id="helpInstructions">
                            <hr>
                            
                            <div class="mb-4">
                                <h6><i class="fas fa-envelope text-primary"></i> <strong>Option 1 : Utiliser Gmail (le plus simple)</strong></h6>
                                <p class="mb-2">Si vous avez une adresse Gmail (comme <code>votrenom@gmail.com</code>), suivez ces 4 étapes :</p>
                                <ol class="mb-2">
                                    <li class="mb-2">
                                        <strong>Tapez votre adresse Gmail</strong> dans le champ "Email" ci-dessous
                                    </li>
                                    <li class="mb-2">
                                        <strong>Ouvrez ce lien dans un nouvel onglet :</strong><br>
                                        <a href="https://myaccount.google.com/apppasswords" target="_blank" class="alert-link btn btn-sm btn-outline-primary mt-1">
                                            <i class="fas fa-external-link-alt"></i> myaccount.google.com/apppasswords
                                        </a>
                                    </li>
                                    <li class="mb-2">
                                        <strong>Google va vous demander votre mot de passe Gmail</strong> (celui que vous utilisez normalement)
                                    </li>
                                    <li class="mb-2">
                                        <strong>Google va générer un code spécial</strong> (16 caractères) :<br>
                                        → <strong>Copiez ce code</strong> et <strong>collez-le</strong> dans le champ "Mot de passe SMTP" ci-dessous<br>
                                        <small class="text-muted">💡 Ce code est différent de votre mot de passe Gmail habituel. C'est normal !</small>
                                    </li>
                                </ol>
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle"></i> <strong>C'est tout !</strong> Vous pouvez maintenant tester puis enregistrer.
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="mb-3">
                                <h6><i class="fas fa-building text-warning"></i> <strong>Option 2 : Utiliser votre email professionnel</strong></h6>
                                <p class="mb-2">Si vous utilisez un email d'entreprise (comme <code>votrenom@votreentreprise.com</code>) :</p>
                                <ol class="mb-2">
                                    <li class="mb-2">
                                        <strong>Tapez votre adresse email professionnelle</strong> dans le champ "Email" ci-dessous
                                    </li>
                                    <li class="mb-2">
                                        <strong>Tapez votre mot de passe email habituel</strong> dans le champ "Mot de passe SMTP"<br>
                                        <small class="text-muted">(Le même mot de passe que vous utilisez pour lire vos emails)</small>
                                    </li>
                                    <li class="mb-2">
                                        <strong>Cliquez sur le lien "Afficher les paramètres avancés"</strong> en bas du formulaire
                                    </li>
                                    <li class="mb-2">
                                        <strong>Modifiez le "Serveur SMTP"</strong> selon votre fournisseur d'email :
                                        <ul class="mt-2">
                                            <li><strong>Microsoft / Office 365 / Outlook :</strong> Tapez <code>smtp.office365.com</code></li>
                                            <li><strong>OVH :</strong> Tapez <code>ssl0.ovh.net</code></li>
                                            <li><strong>Orange Pro :</strong> Tapez <code>smtp.orange.fr</code></li>
                                            <li><strong>Autre fournisseur :</strong> Demandez à votre service informatique quel est le "serveur SMTP"</li>
                                        </ul>
                                        <small class="text-muted">💡 Le port 587 est déjà configuré, pas besoin de le changer.</small>
                                    </li>
                                </ol>
                            </div>
                            
                            <hr>
                            
                            <div class="alert alert-secondary mb-0">
                                <i class="fas fa-lock"></i> <strong>Sécurité :</strong> Vos identifiants (email et mot de passe) sont enregistrés uniquement sur votre serveur. Personne d'autre n'y a accès.
                            </div>
                        </div>
                    </div>
                    
                    <form id="smtpConfigForm">
                        <!-- Champs cachés pour serveur et port (valeurs par défaut Gmail) -->
                        <input type="hidden" id="smtp_server" name="smtp_server" value="smtp.gmail.com">
                        <input type="hidden" id="smtp_port" name="smtp_port" value="587">
                        
                        <div class="mb-3">
                            <label for="smtp_username" class="form-label">
                                <i class="fas fa-envelope"></i> Email <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" id="smtp_username" name="smtp_username" placeholder="votre.email@gmail.com ou votre.email@entreprise.com" required>
                            <small class="text-muted">Adresse email qui enverra les PV (Gmail ou email professionnel)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_password" class="form-label">
                                <i class="fas fa-key"></i> Mot de passe SMTP <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" placeholder="Mdp d'application Gmail ou mdp email pro">
                                <button class="btn btn-outline-secondary btn-toggle-password" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="passwordStatus">Pour Gmail : code à 16 caractères de myaccount.google.com/apppasswords | Pour email pro : votre mot de passe habituel</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_from_name" class="form-label">
                                <i class="fas fa-user"></i> Nom de l'expéditeur
                            </label>
                            <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" placeholder="France Montage" value="France Montage">
                            <small class="text-muted">Le nom qui apparaîtra comme expéditeur des emails</small>
                        </div>
                        
                        <!-- Lien pour afficher les paramètres avancés -->
                        <div class="text-center mb-3">
                            <a href="#" id="showAdvancedSettings" class="text-muted small">
                                <i class="fas fa-cog"></i> Afficher les paramètres avancés (serveur/port)
                            </a>
                        </div>
                        
                        <!-- Paramètres avancés cachés par défaut -->
                        <div id="advancedSettings" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Paramètres avancés</strong> - Ne modifiez ces valeurs que si vous n'utilisez pas Gmail
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="smtp_server_advanced" class="form-label">Serveur SMTP</label>
                                    <input type="text" class="form-control" id="smtp_server_advanced" placeholder="smtp.gmail.com">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="smtp_port_advanced" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="smtp_port_advanced" placeholder="587">
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <div id="smtpConfigAlert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-info" id="testSmtpBtn">
                        <i class="fas fa-flask"></i> Tester la connexion
                    </button>
                    <button type="button" class="btn btn-primary" id="saveSmtpBtn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="clc-footer mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 France Montage - Tous droits réservés</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery (requis pour Select2) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <!-- Script personnalisé -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
